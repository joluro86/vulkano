{% extends 'index.html' %}

{% block breadcrumb %}
  {% include 'breadcrumb.html' with home='/' breadcrumbs=breadcrumb_items %}
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto mt-6 bg-white p-6 rounded shadow">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold text-gray-800">Editar Movimiento #{{ movimiento.id }}</h2>
    <a href="{% url 'inventario_list_stock' %}" class="text-sm text-[var(--primary-color)] hover:underline">← Volver al inventario</a>
  </div>

  <form method="post" class="grid grid-cols-2 gap-4 mb-6">
    {% csrf_token %}
    {% for field in form.visible_fields %}
      <div class="{% if field.name == 'observacion' %}col-span-2{% endif %}">
        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ field.label }}</label>
        {{ field }}
        {% if field.errors %}<p class="text-sm text-red-600">{{ field.errors|striptags }}</p>{% endif %}
      </div>
    {% endfor %}
    <div class="col-span-2">
      <button type="submit" class="w-full bg-[var(--primary-color)] text-white py-2 rounded hover:bg-blue-700 transition">
        Guardar cambios generales
      </button>
    </div>
  </form>

  <hr class="my-6">

  <h3 class="text-xl font-semibold text-gray-700 mb-4">Agregar productos al movimiento</h3>
  <form method="post" class="grid grid-cols-2 gap-4 mb-6">
    {% csrf_token %}
    <div class="col-span-2">
      <input type="text" id="buscar-producto" name="producto_nombre" class="w-full p-2 border rounded" placeholder="Buscar producto por nombre o código..." autocomplete="off">
      <input type="hidden" id="producto-id" name="producto">
    </div>
    <div>{{ item_form.cantidad.label_tag }}{{ item_form.cantidad }}</div>
    <div class="flex items-end">
      <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">Agregar producto</button>
    </div>
  </form>

  {% if movimiento.items.exists %}
    <table class="min-w-full border border-gray-200 text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="px-4 py-2 border">Producto</th>
          <th class="px-4 py-2 border text-right">Cantidad</th>
        </tr>
      </thead>
      <tbody>
        {% for item in movimiento.items.all %}
        <tr>
          <td class="px-4 py-2 border">{{ item.producto.nombre }}</td>
          <td class="px-4 py-2 border text-right">{{ item.cantidad }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="text-gray-500">Aún no se han agregado productos al movimiento.</p>
  {% endif %}
</div>

<script>
  const buscarProductoInput = document.getElementById("buscar-producto");
  const productoIdInput = document.getElementById("producto-id");

  buscarProductoInput.addEventListener("input", function () {
    if (this.value.length < 3) return;
    fetch(`/productos/buscar/?q=${this.value}`)
      .then(response => response.json())
      .then(data => {
        if (data.length > 0) {
          productoIdInput.value = data[0].id;
        } else {
          productoIdInput.value = "";
        }
      });
  });
</script>
{% endblock %}